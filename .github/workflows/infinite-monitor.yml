# Infinite Loop Monitoring Workflow
# Continuously monitors and fixes errors every 30 minutes
name: Infinite Loop Monitor

on:
  schedule:
    # Run every 30 minutes
    - cron: '0,30 * * * *'
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug mode'
        required: false
        default: 'false'

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'
  MAX_FIX_ATTEMPTS: 15

jobs:
  # ============================================
  # Phase 1: Health Check
  # ============================================
  health-check:
    name: System Health Check
    runs-on: ubuntu-latest
    outputs:
      backend_health: ${{ steps.check.outputs.backend_health }}
      frontend_health: ${{ steps.check.outputs.frontend_health }}
      db_health: ${{ steps.check.outputs.db_health }}
      overall_health: ${{ steps.check.outputs.overall_health }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up environments
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Check system health
        id: check
        run: |
          BACKEND_HEALTH="healthy"
          FRONTEND_HEALTH="healthy"
          DB_HEALTH="healthy"

          # Check backend files exist
          if [ ! -f "backend/api/main.py" ]; then
            BACKEND_HEALTH="unhealthy"
          fi

          # Check frontend files exist
          if [ ! -f "frontend/package.json" ]; then
            FRONTEND_HEALTH="unhealthy"
          fi

          # Check alembic config
          if [ ! -f "alembic.ini" ]; then
            DB_HEALTH="unhealthy"
          fi

          # Determine overall health
          if [ "$BACKEND_HEALTH" == "healthy" ] && [ "$FRONTEND_HEALTH" == "healthy" ] && [ "$DB_HEALTH" == "healthy" ]; then
            OVERALL_HEALTH="healthy"
          else
            OVERALL_HEALTH="unhealthy"
          fi

          echo "backend_health=${BACKEND_HEALTH}" >> $GITHUB_OUTPUT
          echo "frontend_health=${FRONTEND_HEALTH}" >> $GITHUB_OUTPUT
          echo "db_health=${DB_HEALTH}" >> $GITHUB_OUTPUT
          echo "overall_health=${OVERALL_HEALTH}" >> $GITHUB_OUTPUT

  # ============================================
  # Phase 2: Error Detection Loop
  # ============================================
  error-detection-loop:
    name: Error Detection Loop
    runs-on: ubuntu-latest
    needs: health-check
    outputs:
      errors_found: ${{ steps.detect.outputs.errors_found }}
      error_log: ${{ steps.detect.outputs.error_log }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install all dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          cd frontend && npm ci || npm install

      - name: Run comprehensive error detection
        id: detect
        run: |
          ERROR_LOG=""
          ERRORS_FOUND="false"

          echo "=== Starting Error Detection ===" >> error_log.txt
          echo "Timestamp: $(date -u)" >> error_log.txt
          echo "" >> error_log.txt

          # 1. Python Syntax Errors
          echo "Checking Python syntax..." >> error_log.txt
          python -m py_compile backend/api/main.py 2>> error_log.txt || { ERRORS_FOUND="true"; echo "PYTHON_SYNTAX_ERROR" >> error_log.txt; }

          # 2. Python Lint Errors
          echo "Checking Python lint..." >> error_log.txt
          ruff check backend/ 2>> error_log.txt || { ERRORS_FOUND="true"; echo "PYTHON_LINT_ERROR" >> error_log.txt; }

          # 3. Python Format Errors
          echo "Checking Python format..." >> error_log.txt
          black --check backend/ 2>> error_log.txt || { ERRORS_FOUND="true"; echo "PYTHON_FORMAT_ERROR" >> error_log.txt; }

          # 4. Python Import Errors
          echo "Checking Python imports..." >> error_log.txt
          python -c "from backend.api.main import app" 2>> error_log.txt || { ERRORS_FOUND="true"; echo "PYTHON_IMPORT_ERROR" >> error_log.txt; }

          # 5. Frontend Lint Errors
          echo "Checking Frontend lint..." >> error_log.txt
          cd frontend
          npm run lint 2>> ../error_log.txt || { ERRORS_FOUND="true"; echo "FRONTEND_LINT_ERROR" >> ../error_log.txt; }

          # 6. Frontend Build Errors
          echo "Checking Frontend build..." >> ../error_log.txt
          npm run build 2>> ../error_log.txt || { ERRORS_FOUND="true"; echo "FRONTEND_BUILD_ERROR" >> ../error_log.txt; }

          cd ..

          # 7. Test Errors
          echo "Running tests..." >> error_log.txt
          pytest backend/tests/ -v 2>> error_log.txt || { ERRORS_FOUND="true"; echo "TEST_ERROR" >> error_log.txt; }

          echo "errors_found=${ERRORS_FOUND}" >> $GITHUB_OUTPUT

          # Save error log
          ERROR_LOG=$(cat error_log.txt | base64 -w0)
          echo "error_log=${ERROR_LOG}" >> $GITHUB_OUTPUT

  # ============================================
  # Phase 3: Auto Fix Loop (15 iterations)
  # ============================================
  auto-fix-loop:
    name: Auto Fix Attempt
    runs-on: ubuntu-latest
    needs: error-detection-loop
    if: needs.error-detection-loop.outputs.errors_found == 'true'
    strategy:
      max-parallel: 1
      fail-fast: false
      matrix:
        iteration: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up environments
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          cd frontend && npm ci || npm install

      - name: Fix Attempt ${{ matrix.iteration }}
        id: fix
        run: |
          echo "=== Fix Attempt ${{ matrix.iteration }} of ${{ env.MAX_FIX_ATTEMPTS }} ==="
          FIXED="false"

          # Auto-fix Python
          echo "Fixing Python code..."
          ruff check backend/ --fix --unsafe-fixes 2>/dev/null || true
          ruff format backend/ 2>/dev/null || true
          black backend/ 2>/dev/null || true

          # Auto-fix Frontend
          echo "Fixing Frontend code..."
          cd frontend
          npx eslint src/ --fix 2>/dev/null || true
          npx prettier --write src/ 2>/dev/null || true
          cd ..

          # Verify fixes
          STILL_HAS_ERRORS="false"

          ruff check backend/ --quiet 2>/dev/null || STILL_HAS_ERRORS="true"
          black --check backend/ --quiet 2>/dev/null || STILL_HAS_ERRORS="true"
          cd frontend
          npm run lint --silent 2>/dev/null || STILL_HAS_ERRORS="true"
          cd ..

          if [ "$STILL_HAS_ERRORS" == "false" ]; then
            FIXED="true"
          fi

          echo "fixed=${FIXED}" >> $GITHUB_OUTPUT
          echo "Iteration ${{ matrix.iteration }} result: fixed=${FIXED}"

      - name: Commit if fixed
        if: steps.fix.outputs.fixed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add -A
          if ! git diff --staged --quiet; then
            git commit -m "fix: auto-fix iteration ${{ matrix.iteration }}

            Automated error fixes applied by Infinite Loop Monitor.
            Iteration: ${{ matrix.iteration }}/${{ env.MAX_FIX_ATTEMPTS }}

            Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
            git push
          fi

  # ============================================
  # Phase 4: Verification
  # ============================================
  verification:
    name: Final Verification
    runs-on: ubuntu-latest
    needs: [error-detection-loop, auto-fix-loop]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Set up environments
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install and verify
        id: final_check
        run: |
          pip install -r backend/requirements.txt
          cd frontend && npm ci || npm install && cd ..

          FINAL_STATUS="success"

          ruff check backend/ --quiet 2>/dev/null || FINAL_STATUS="failure"
          black --check backend/ --quiet 2>/dev/null || FINAL_STATUS="failure"
          cd frontend
          npm run lint --silent 2>/dev/null || FINAL_STATUS="failure"

          echo "status=${FINAL_STATUS}" >> $GITHUB_OUTPUT

      - name: Generate report
        run: |
          echo "## Infinite Loop Monitor Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Final Status:** ${{ steps.final_check.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Phase Results" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Error Detection | ${{ needs.error-detection-loop.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Auto Fix Loop | ${{ needs.auto-fix-loop.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next scheduled run:** In 30 minutes" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Phase 5: Issue Management
  # ============================================
  issue-management:
    name: Issue Management
    runs-on: ubuntu-latest
    needs: verification
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create or update tracking issue
        uses: actions/github-script@v7
        with:
          script: |
            const timestamp = new Date().toISOString();
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;

            // Search for existing monitoring issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'monitoring',
              state: 'open'
            });

            const body = `
            ## Infinite Loop Monitor Status

            **Last Updated:** ${timestamp}

            ### Latest Run
            - **Status:** ${{ needs.verification.result }}
            - **Run URL:** [View Run](${runUrl})

            ### Configuration
            - **Schedule:** Every 30 minutes
            - **Max Fix Attempts:** 15 per cycle
            - **Auto-commit:** Enabled

            ### History
            This issue is automatically updated by the monitoring workflow.
            `;

            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });
              console.log(`Updated issue #${issues.data[0].number}`);
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '[Monitor] Infinite Loop Error Detection Status',
                body: body,
                labels: ['monitoring', 'automated']
              });
              console.log('Created new monitoring issue');
            }
