# エラーコード一覧 (Error Codes)

## 1. 概要

本ドキュメントは、Personal Recipe Intelligence (PRI) API で使用されるエラーコードの一覧と詳細を定義する。

## 2. エラーレスポンス形式

```json
{
  "status": "error",
  "data": null,
  "error": {
    "code": "ERROR_CODE",
    "message": "エラーメッセージ",
    "details": { ... }
  }
}
```

## 3. 共通エラーコード

### 3.1 バリデーションエラー (4xx)

| コード | HTTPステータス | 説明 | 対処法 |
|--------|---------------|------|--------|
| VALIDATION_ERROR | 422 | 入力値が不正 | リクエストパラメータを確認 |
| REQUIRED_FIELD | 422 | 必須フィールドが未入力 | 必須フィールドを入力 |
| INVALID_FORMAT | 422 | フォーマットが不正 | 正しい形式で入力 |
| OUT_OF_RANGE | 422 | 値が範囲外 | 許容範囲内の値を入力 |
| INVALID_TYPE | 422 | データ型が不正 | 正しいデータ型で入力 |
| TOO_LONG | 422 | 文字数超過 | 文字数を減らす |
| TOO_SHORT | 422 | 文字数不足 | 文字数を増やす |

### 3.2 認証・認可エラー

| コード | HTTPステータス | 説明 | 対処法 |
|--------|---------------|------|--------|
| UNAUTHORIZED | 401 | 認証が必要 | 認証情報を提供 |
| FORBIDDEN | 403 | アクセス権限なし | 権限を確認 |
| TOKEN_EXPIRED | 401 | トークン有効期限切れ | トークンを再取得 |
| INVALID_TOKEN | 401 | トークンが不正 | 正しいトークンを使用 |

### 3.3 リソースエラー

| コード | HTTPステータス | 説明 | 対処法 |
|--------|---------------|------|--------|
| NOT_FOUND | 404 | リソースが見つからない | IDを確認 |
| ALREADY_EXISTS | 409 | リソースが既に存在 | 別の値を使用 |
| CONFLICT | 409 | 競合が発生 | データを再取得して再試行 |
| DELETED | 410 | リソースは削除済み | 別のリソースを使用 |

## 4. 機能別エラーコード

### 4.1 レシピ関連

| コード | HTTPステータス | 説明 | 対処法 |
|--------|---------------|------|--------|
| RECIPE_NOT_FOUND | 404 | レシピが見つからない | レシピIDを確認 |
| RECIPE_ALREADY_EXISTS | 409 | 同名レシピが存在 | 別のタイトルを使用 |
| INVALID_INGREDIENTS | 422 | 材料データが不正 | 材料形式を確認 |
| INVALID_STEPS | 422 | 手順データが不正 | 手順形式を確認 |
| NO_INGREDIENTS | 422 | 材料が未入力 | 最低1件の材料を追加 |
| NO_STEPS | 422 | 手順が未入力 | 最低1件の手順を追加 |

### 4.2 スクレイピング関連

| コード | HTTPステータス | 説明 | 対処法 |
|--------|---------------|------|--------|
| INVALID_URL | 400 | URLが不正 | 正しいURLを入力 |
| SITE_NOT_SUPPORTED | 422 | 対応外のサイト | 対応サイトを使用 |
| ROBOTS_BLOCKED | 403 | robots.txtで禁止 | 手動入力を使用 |
| FETCH_FAILED | 502 | ページ取得失敗 | URLを確認 |
| PARSE_FAILED | 422 | 解析失敗 | ページを手動で確認 |
| RATE_LIMITED | 429 | レート制限 | 時間をおいて再試行 |
| TIMEOUT | 504 | タイムアウト | 再試行 |
| SITE_STRUCTURE_CHANGED | 422 | サイト構造変更 | 管理者に報告 |

### 4.3 OCR関連

| コード | HTTPステータス | 説明 | 対処法 |
|--------|---------------|------|--------|
| INVALID_FILE | 400 | ファイル形式が不正 | 対応形式を使用 |
| FILE_TOO_LARGE | 413 | ファイルサイズ超過 | 10MB以下に圧縮 |
| FILE_TOO_SMALL | 400 | ファイルサイズ不足 | 有効なファイルを使用 |
| LOW_QUALITY_IMAGE | 422 | 画像品質が低い | 高品質な画像を使用 |
| NO_TEXT_DETECTED | 422 | テキスト未検出 | 鮮明な画像を使用 |
| OCR_PARSE_FAILED | 422 | 構造化失敗 | 手動で編集 |
| UNSUPPORTED_FORMAT | 415 | 対応外の形式 | JPEG/PNG/WebPを使用 |

### 4.4 翻訳関連

| コード | HTTPステータス | 説明 | 対処法 |
|--------|---------------|------|--------|
| TRANSLATION_FAILED | 502 | 翻訳失敗 | 再試行 |
| TRANSLATION_QUOTA_EXCEEDED | 429 | 翻訳クォータ超過 | 翌月まで待機 |
| UNSUPPORTED_LANGUAGE | 422 | 対応外の言語 | 対応言語を使用 |
| TRANSLATION_TIMEOUT | 504 | 翻訳タイムアウト | 再試行 |

### 4.5 タグ関連

| コード | HTTPステータス | 説明 | 対処法 |
|--------|---------------|------|--------|
| TAG_NOT_FOUND | 404 | タグが見つからない | タグIDを確認 |
| TAG_ALREADY_EXISTS | 409 | 同名タグが存在 | 別の名前を使用 |
| TAG_IN_USE | 409 | タグが使用中 | レシピから削除後に削除 |

## 5. システムエラー

| コード | HTTPステータス | 説明 | 対処法 |
|--------|---------------|------|--------|
| INTERNAL_ERROR | 500 | 内部エラー | 管理者に連絡 |
| DATABASE_ERROR | 500 | データベースエラー | 管理者に連絡 |
| SERVICE_UNAVAILABLE | 503 | サービス停止中 | 時間をおいて再試行 |
| EXTERNAL_API_ERROR | 502 | 外部API障害 | 時間をおいて再試行 |
| MCP_ERROR | 500 | MCP接続エラー | 管理者に連絡 |

## 6. エラー詳細例

### 6.1 バリデーションエラー

```json
{
  "status": "error",
  "data": null,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "入力値に問題があります",
    "details": [
      {
        "field": "title",
        "code": "REQUIRED_FIELD",
        "message": "タイトルは必須です"
      },
      {
        "field": "servings",
        "code": "OUT_OF_RANGE",
        "message": "分量は1〜100の範囲で入力してください",
        "constraints": {
          "min": 1,
          "max": 100
        }
      }
    ]
  }
}
```

### 6.2 スクレイピングエラー

```json
{
  "status": "error",
  "data": null,
  "error": {
    "code": "SCRAPE_FAILED",
    "message": "レシピの取得に失敗しました",
    "details": {
      "reason": "SITE_STRUCTURE_CHANGED",
      "url": "https://example.com/recipe/123",
      "selector": ".recipe-ingredients",
      "suggestion": "サイトの構造が変更された可能性があります"
    }
  }
}
```

### 6.3 OCRエラー

```json
{
  "status": "error",
  "data": null,
  "error": {
    "code": "OCR_FAILED",
    "message": "テキストの抽出に失敗しました",
    "details": {
      "reason": "LOW_QUALITY_IMAGE",
      "confidence": 0.35,
      "suggestions": [
        "より高解像度の画像を使用してください",
        "照明を改善してください",
        "画像の歪みを修正してください"
      ]
    }
  }
}
```

## 7. HTTPステータスコード対応表

| ステータス | カテゴリ | 説明 |
|-----------|----------|------|
| 200 | 成功 | リクエスト成功 |
| 201 | 成功 | リソース作成成功 |
| 204 | 成功 | 削除成功（本文なし） |
| 400 | クライアントエラー | リクエスト不正 |
| 401 | クライアントエラー | 認証が必要 |
| 403 | クライアントエラー | アクセス禁止 |
| 404 | クライアントエラー | リソース未発見 |
| 409 | クライアントエラー | 競合 |
| 413 | クライアントエラー | ペイロード過大 |
| 415 | クライアントエラー | 非対応メディアタイプ |
| 422 | クライアントエラー | 処理不可エンティティ |
| 429 | クライアントエラー | レート制限 |
| 500 | サーバーエラー | 内部エラー |
| 502 | サーバーエラー | 外部サービスエラー |
| 503 | サーバーエラー | サービス停止 |
| 504 | サーバーエラー | タイムアウト |

## 8. 改訂履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|----------|
| 2024-12-11 | 1.0.0 | 初版作成 |
