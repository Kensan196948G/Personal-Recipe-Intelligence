# SubAgents 並列開発ワークフロー
# ClaudeCode SubAgents の並列動作をシミュレート
name: SubAgents 並列開発

on:
  workflow_dispatch:
    inputs:
      task_type:
        description: '処理するタスクタイプ'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - backend
          - frontend
          - scraper
          - ocr
          - translation
          - cleaner
          - qa
          - docs
  issues:
    types: [opened, labeled]
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'

jobs:
  # ============================================
  # プランナーエージェント - タスク調整
  # ============================================
  planner-agent:
    name: "[エージェント] プランナー"
    runs-on: ubuntu-latest
    outputs:
      tasks: ${{ steps.plan.outputs.tasks }}
      task_count: ${{ steps.plan.outputs.task_count }}
    steps:
      - name: チェックアウト
        uses: actions/checkout@v4

      - name: タスクを分析・計画
        id: plan
        run: |
          TASK_TYPE="${{ github.event.inputs.task_type || 'all' }}"

          if [ "$TASK_TYPE" == "all" ]; then
            TASKS='["backend","frontend","qa"]'
            TASK_COUNT=3
          else
            TASKS="[\"${TASK_TYPE}\"]"
            TASK_COUNT=1
          fi

          echo "tasks=${TASKS}" >> $GITHUB_OUTPUT
          echo "task_count=${TASK_COUNT}" >> $GITHUB_OUTPUT

          echo "## プランナーエージェント レポート" >> $GITHUB_STEP_SUMMARY
          echo "実行タスク: ${TASKS}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # DevAPI エージェント - バックエンド開発
  # ============================================
  devapi-agent:
    name: "[エージェント] DevAPI"
    runs-on: ubuntu-latest
    needs: planner-agent
    if: contains(needs.planner-agent.outputs.tasks, 'backend') || contains(needs.planner-agent.outputs.tasks, 'all')
    steps:
      - name: チェックアウト
        uses: actions/checkout@v4

      - name: Python をセットアップ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: 依存関係をインストール
        run: |
          pip install -r backend/requirements.txt

      - name: DevAPI エージェント - コード品質
        run: |
          echo "=== DevAPI エージェント: コード品質チェックを実行 ==="

          # リントとフォーマット
          ruff check backend/ --fix --unsafe-fixes || true
          ruff format backend/ || true
          black backend/ || true

          # 型チェック
          pip install mypy types-requests
          mypy backend/ --ignore-missing-imports || true

          echo "## DevAPI エージェント レポート" >> $GITHUB_STEP_SUMMARY
          echo "- コード品質チェック完了" >> $GITHUB_STEP_SUMMARY
          echo "- 自動修正を適用" >> $GITHUB_STEP_SUMMARY

      - name: 変更をコミット
        run: |
          git config --local user.email "devapi-agent@pri.local"
          git config --local user.name "DevAPI エージェント"
          git add -A
          git diff --staged --quiet || git commit -m "refactor(backend): DevAPI エージェントによる改善

          DevAPI エージェントによる自動コード品質改善。

          Co-Authored-By: DevAPI エージェント <devapi-agent@pri.local>"

  # ============================================
  # DevUI エージェント - フロントエンド開発
  # ============================================
  devui-agent:
    name: "[エージェント] DevUI"
    runs-on: ubuntu-latest
    needs: planner-agent
    if: contains(needs.planner-agent.outputs.tasks, 'frontend') || contains(needs.planner-agent.outputs.tasks, 'all')
    steps:
      - name: チェックアウト
        uses: actions/checkout@v4

      - name: Node.js をセットアップ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: 依存関係をインストール
        working-directory: frontend
        run: npm ci || npm install

      - name: DevUI エージェント - コード品質
        working-directory: frontend
        run: |
          echo "=== DevUI エージェント: コード品質チェックを実行 ==="

          # リントとフォーマット
          npx eslint src/ --fix || true
          npx prettier --write src/ || true

          # ビルドチェック
          npm run build || true

          echo "## DevUI エージェント レポート" >> $GITHUB_STEP_SUMMARY
          echo "- フロントエンドリント完了" >> $GITHUB_STEP_SUMMARY
          echo "- Prettier フォーマット適用" >> $GITHUB_STEP_SUMMARY

      - name: 変更をコミット
        run: |
          git config --local user.email "devui-agent@pri.local"
          git config --local user.name "DevUI エージェント"
          git add -A
          git diff --staged --quiet || git commit -m "refactor(frontend): DevUI エージェントによる改善

          DevUI エージェントによる自動コード品質改善。

          Co-Authored-By: DevUI エージェント <devui-agent@pri.local>"

  # ============================================
  # QA エージェント - 品質保証
  # ============================================
  qa-agent:
    name: "[エージェント] QA"
    runs-on: ubuntu-latest
    needs: [planner-agent, devapi-agent, devui-agent]
    if: always() && (contains(needs.planner-agent.outputs.tasks, 'qa') || contains(needs.planner-agent.outputs.tasks, 'all'))
    steps:
      - name: チェックアウト
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Python をセットアップ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Node.js をセットアップ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: すべての依存関係をインストール
        run: |
          pip install -r backend/requirements.txt
          cd frontend && npm ci || npm install

      - name: QA エージェント - テスト実行
        run: |
          echo "=== QA エージェント: すべてのテストを実行 ==="

          # バックエンドテスト
          pytest backend/tests/ -v --tb=short || true

          # フロントエンドテスト（設定済みの場合）
          cd frontend
          npm test 2>/dev/null || echo "フロントエンドテストは設定されていません"

          echo "## QA エージェント レポート" >> $GITHUB_STEP_SUMMARY
          echo "- バックエンドテスト実行" >> $GITHUB_STEP_SUMMARY
          echo "- フロントエンドテスト実行" >> $GITHUB_STEP_SUMMARY

      - name: QA エージェント - 最終検証
        id: verify
        run: |
          PASS_COUNT=0
          FAIL_COUNT=0

          # リントチェック
          if ruff check backend/ --quiet 2>/dev/null; then
            ((PASS_COUNT++))
          else
            ((FAIL_COUNT++))
          fi

          # フォーマットチェック
          if black --check backend/ --quiet 2>/dev/null; then
            ((PASS_COUNT++))
          else
            ((FAIL_COUNT++))
          fi

          # フロントエンドリントチェック
          cd frontend
          if npm run lint --silent 2>/dev/null; then
            ((PASS_COUNT++))
          else
            ((FAIL_COUNT++))
          fi

          echo "pass_count=${PASS_COUNT}" >> $GITHUB_OUTPUT
          echo "fail_count=${FAIL_COUNT}" >> $GITHUB_OUTPUT

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 最終結果" >> $GITHUB_STEP_SUMMARY
          echo "- 成功: ${PASS_COUNT}" >> $GITHUB_STEP_SUMMARY
          echo "- 失敗: ${FAIL_COUNT}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # コーディネーター - 全変更をマージ
  # ============================================
  coordinator:
    name: "[コーディネーター] 変更をマージ"
    runs-on: ubuntu-latest
    needs: [devapi-agent, devui-agent, qa-agent]
    if: always()
    steps:
      - name: チェックアウト
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: すべてのエージェントの変更をマージ
        run: |
          git config --local user.email "coordinator@pri.local"
          git config --local user.name "SubAgent コーディネーター"

          # 変更を取得
          git pull --rebase origin ${{ github.ref_name }} || true

          # 変更があればプッシュ
          git push || true

      - name: 最終レポートを生成
        run: |
          echo "## SubAgents 並列開発 - 最終レポート" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**完了:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| エージェント | ステータス |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| プランナー | ${{ needs.planner-agent.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DevAPI | ${{ needs.devapi-agent.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DevUI | ${{ needs.devui-agent.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| QA | ${{ needs.qa-agent.result }} |" >> $GITHUB_STEP_SUMMARY
